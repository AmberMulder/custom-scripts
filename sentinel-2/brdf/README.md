# BRDF Normalisation Script - Sentinel 2

#### True Color

<a href="#" id='togglescript'>Show</a> script or [download](script.js){:target="_blank"} it.
<div id='script_view' style="display:none">
{% highlight javascript %}
{% include_relative script.js %}
{% endhighlight %}
</div>

#### Raw Values

<a href="#" id='togglescript'>Show</a> script or [download](script_raw.js){:target="_blank"} it.
<div id='script_view' style="display:none">
{% highlight javascript %}
{% include_relative script.js %}
{% endhighlight %}
</div>

## Evaluate and visualize
 - [EO Browser](https://apps.sentinel-hub.com/eo-browser/?zoom=10&lat=-25.56846&lng=138.1723&themeId=DEFAULT-THEME&visualizationUrl=https%3A%2F%2Fservices.sentinel-hub.com%2Fogc%2Fwms%2Fbd86bcc0-f318-402b-a145-015f85b9427e&evalscript=Ly9WRVJTSU9OPTMKCmZ1bmN0aW9uIHNldHVwKCkgewogICAgcmV0dXJuIHsKICAgICAgICBpbnB1dDogWyJCMDIiLCAiQjAzIiwgIkIwNCIsICJzdW5BemltdXRoQW5nbGVzIiwgInN1blplbml0aEFuZ2xlcyIsICJ2aWV3QXppbXV0aE1lYW4iLCAidmlld1plbml0aE1lYW4iXSwKICAgICAgICBvdXRwdXQ6IHsgYmFuZHM6IDMgfSwKICAgICAgICBtb3NhaWNraW5nOiAiVElMRSIKICAgIH07Cn0KCmZ1bmN0aW9uIGV2YWx1YXRlUGl4ZWwoc2FtcGxlKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZS5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIE9ubHkgY2FsY3VsYXRlIHRoZSBCUkRGIGZvciBwaXhlbHMgd2hlcmUgdGhlIAogICAgICAgIC8vIHZpZXcgZ2VvbWV0cnkgaXMgYXZhaWxhYmxlIChvbiB0aGUgZWRnZXMgb2YgdGlsZXMKICAgICAgICAvLyByZWZsZWN0YW5jZSBpcyBhdmFpbGFibGUgYnV0IG5vdCB2aWV3IGdlb21ldHJ5KQogICAgICAgIGlmIChzYW1wbGVbaV0udmlld0F6aW11dGhNZWFuID4gMSkgewogICAgICAgICAgICBsZXQgYXZhaWxhYmxlID0gc2FtcGxlW2ldCiAgICAgICAgICAgIGxldCBzYWEgPSBkZWcycmFkKGF2YWlsYWJsZS5zdW5BemltdXRoQW5nbGVzKTsKICAgICAgICAgICAgbGV0IHN6YSA9IGRlZzJyYWQoYXZhaWxhYmxlLnN1blplbml0aEFuZ2xlcyk7CiAgICAgICAgICAgIGxldCB2YWEgPSBkZWcycmFkKGF2YWlsYWJsZS52aWV3QXppbXV0aE1lYW4pOwogICAgICAgICAgICBsZXQgdnphID0gZGVnMnJhZChhdmFpbGFibGUudmlld1plbml0aE1lYW4pOwoKICAgICAgICAgICAgbGV0IGNvbnN0YW50ID0gYnVpbGRfY29uc3RhbnRzKHN6YSwgdnphLCBzYWEsIHZhYSk7CiAgICAgICAgICAgIGxldCBjX3Z6YV96ZXJvID0gYnVpbGRfY29uc3RhbnRzKHN6YSwgMCwgc2FhLCB2YWEpOwogICAgICAgICAgICBsZXQga2VybmVscyA9IHsKICAgICAgICAgICAgICAgIGtnZW86IGNhbGNfa2dlbyhjb25zdGFudCksCiAgICAgICAgICAgICAgICBrdm9sOiBjYWxjX2t2b2woY29uc3RhbnQpLAogICAgICAgICAgICAgICAga2dlb192emFfemVybzogY2FsY19rZ2VvKGNfdnphX3plcm8pLAogICAgICAgICAgICAgICAga3ZvbF92emFfemVybzogY2FsY19rdm9sKGNfdnphX3plcm8pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBiYW5kcyA9IE9iamVjdC5rZXlzKGZfdmFsdWVzKTsKICAgICAgICAgICAgbGV0IGx1bSA9IDIuNSAvLyBicmlnaHRuZXNzIG9mIHRoZSBpbWFnZQogICAgICAgICAgICByZXR1cm4gYmFuZHMubWFwKGJhbmQgPT4gbHVtICogY2FsY19uYmFyKAogICAgICAgICAgICAgICAgYXZhaWxhYmxlW2JhbmRdLAogICAgICAgICAgICAgICAgZl92YWx1ZXNbYmFuZF0sCiAgICAgICAgICAgICAgICBrZXJuZWxzKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIFswLCAwLCAwXQp9CgovLyBLZXJuZWwgUGFyYW1ldGVycyAoUm95IGV0IGFsLiAyMDE3LCBUYWJsZSAxKQovLyBbZl9pc28sIGZfZ2VvLCBmX3ZvbF0KdmFyIGZfdmFsdWVzID0gewogICAgIkIwNCI6IFswLjE2OTAsIDAuMDIyNywgMC4wNTc0XSwKICAgICJCMDMiOiBbMC4xMzA2LCAwLjAxNzgsIDAuMDU4MF0sCiAgICAiQjAyIjogWzAuMDc3NCwgMC4wMDc5LCAwLjAzNzJdCn0KCmZ1bmN0aW9uIGJ1aWxkX2NvbnN0YW50cyhzemEsIHZ6YSwgc2FhLCB2YWEpIHsKICAgIC8vIGNhbGN1bGF0ZXMgY29uc3RhbnRzIGZyb20gdmlld2luZyBnZW9tZXRyeSB0aGF0IGFyZSBvZnRlbiBuZWVkZWQgaW4gdGhlCiAgICAvLyBjYWxjdWxhdGlvbnMgYW5kIGFyZSBleHBlbnNpdmUgdG8gY2FsY3VsYXRlIChpLmUuIHRhbikKICAgIGNvbnN0IHBoaSA9IHJlbGF0aXZlX2F6aW11dGgoc2FhLCB2YWEpOwogICAgbGV0IGMgPSB7CiAgICAgICAgY29zOiB7CiAgICAgICAgICAgIHN6YTogTWF0aC5jb3Moc3phKSwKICAgICAgICAgICAgdnphOiBNYXRoLmNvcyh2emEpLAogICAgICAgICAgICBwaGk6IE1hdGguY29zKHBoaSksCiAgICAgICAgfSwKICAgICAgICBzaW46IHsKICAgICAgICAgICAgc3phOiBNYXRoLnNpbihzemEpLAogICAgICAgICAgICB2emE6IE1hdGguc2luKHZ6YSksCiAgICAgICAgICAgIHBoaTogTWF0aC5zaW4ocGhpKSwKICAgICAgICB9LAogICAgICAgIHNlYzogewogICAgICAgICAgICBzemE6IHNlYyhzemEpLAogICAgICAgICAgICB2emE6IHNlYyh2emEpLAogICAgICAgIH0sCiAgICAgICAgdGFuOiB7fQogICAgfTsKICAgIGMudGFuLnN6YSA9IGMuc2luLnN6YSAvIGMuY29zLnN6YTsKICAgIGMudGFuLnZ6YSA9IGMuc2luLnZ6YSAvIGMuY29zLnZ6YTsKICAgIC8vYyA0MyBMdWNodAogICAgYy5jb3NfeGkgPSBjLmNvcy5zemEgKiBjLmNvcy52emEgKyBjLnNpbi5zemEgKiBjLnNpbi52emEgKiBjLmNvcy5waGk7CiAgICByZXR1cm4gYwp9CgpmdW5jdGlvbiBkZWcycmFkKHgpIHsKICAgIC8vIENvbnZlcnQgZGVncmVlcyB0byByYWRpYW5zCiAgICByZXR1cm4geCAqIE1hdGguUEkgLyAxODA7Cn0KCmZ1bmN0aW9uIHNlYyh4KSB7CiAgICAvLyBDYWxjdWxhdGUgdGhlIHNlY2FudCBvZiBhIHZhbHVlCiAgICByZXR1cm4gMSAvIE1hdGguY29zKHgpOwp9CgpmdW5jdGlvbiByZWxhdGl2ZV9hemltdXRoKHNhYSwgdmFhKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVsYXRpdmUgYXppbXV0aCBhbmdsZQogICAgLy8gQW5nbGVzIGluIFJBRCAhCiAgICBsZXQgcGhpID0gTWF0aC5hYnMoc2FhIC0gdmFhKQogICAgbGV0IGRpZmYgPSAwCiAgICBpZiAocGhpID4gTWF0aC5QSSkgewogICAgICAgIGRpZmYgPSAyICogTWF0aC5QSSAtIHBoaTsKICAgIH0gZWxzZSB7CiAgICAgICAgZGlmZiA9IHBoaTsKICAgIH0KICAgIHJldHVybiBkaWZmOwp9CgpmdW5jdGlvbiBjYWxjX2tnZW8oYykgewogICAgLy8gQ2FsY3VsYXRlIHRoZSBMaVNwYXJzZSBrZXJuZWwgZnJvbSBMdWNodCBldCBhbC4gMjAwMAogICAgLy8gQW5nbGVzIGluIFJBRCAhCgogICAgLy8gc3phID0gdGhldGFfcHJpbWUgPSBNYXRoLmF0YW4oYiAvIHIgKiBNYXRoLnRhbihzemEpKSBzaW1wbGlmaWVzIGJlY2F1c2UgYi9yID0gMQogICAgLy8gdnphID0gbGV0dGhldGFfcHJpbWUgPSBNYXRoLmF0YW4oYiAvIHIgKiBNYXRoLnRhbih2emEpKSBzaW1wbGlmaWVzIGJlY2F1c2UgYi9yID0gMQoKICAgIC8vYyA0MiBMdWNodAogICAgbGV0IERzcSA9IE1hdGgucG93KGMudGFuLnN6YSwgMikgKyBNYXRoLnBvdyhjLnRhbi52emEsIDIpIC0gMiAqIGMudGFuLnN6YSAqIGMudGFuLnZ6YSAqIGMuY29zLnBoaTsKICAgIGxldCB0YW50YW5zaW4gPSBjLnRhbi5zemEgKiBjLnRhbi52emEgKiBjLnNpbi5waGk7CiAgICBsZXQgY29zdHRvcCA9IE1hdGguc3FydChEc3EgKyBNYXRoLnBvdyh0YW50YW5zaW4sIDIpKQoKICAgIC8vYyA0MSBMdWNodAogICAgbGV0IGNvc3QgPSAyICogY29zdHRvcCAvIChjLnNlYy5zemEgKyBjLnNlYy52emEpCiAgICBsZXQgdCA9IE1hdGguYWNvcyhNYXRoLm1pbigxLCBjb3N0KSk7CgogICAgLy8gYyA0MCBMdWNodAogICAgbGV0IGJpZ19vID0gKDEgLyBNYXRoLlBJKSAqICh0IC0gTWF0aC5zaW4odCkgKiBNYXRoLmNvcyh0KSkgKiAoYy5zZWMuc3phICsgYy5zZWMudnphKTsKCiAgICAvLyBLZ2VvCiAgICBsZXQga2dlbyA9IGJpZ19vIC0gYy5zZWMuc3phIC0gYy5zZWMudnphICsgMSAvIDIgKiAoMSArIGMuY29zX3hpKSAqIGMuc2VjLnN6YSAqIGMuc2VjLnZ6YTsKCiAgICByZXR1cm4ga2dlbzsKfQoKZnVuY3Rpb24gY2FsY19rdm9sKGMpIHsKICAgIC8vQ2FsY3VsYXRlIHRoZSBSb3NzVGhpY2sga2VybmVsIChrX3ZvbCkgZnJvbSBMdWNodCBldCBhbC4gMjAwMCBlcXVhdGlvbiAzOAogICAgLy8gQW5nbGVzIGluIFJBRCAhCgogICAgLy8gZXEgNDQKICAgIC8vIHN6YSA9IHRoZXRhX3ByaW1lID0gTWF0aC5hdGFuKGIgLyByICogTWF0aC50YW4oc3phKSkgc2ltcGxpZmllcyBiZWNhdXNlIGIvciA9IDEKICAgIC8vIHZ6YSA9IGxldHRoZXRhID0gTWF0aC5hdGFuKGIgLyByICogTWF0aC50YW4odnphKSkgc2ltcGxpZmllcyBiZWNhdXNlIGIvciA9IDEKICAgIGxldCB4aSA9IE1hdGguYWNvcyhjLmNvc194aSk7CgogICAgbGV0IGt2b2wgPSAoKE1hdGguUEkgLyAyIC0geGkpICogYy5jb3NfeGkgKyBNYXRoLnNpbih4aSkpIC8gKGMuY29zLnN6YSArIGMuY29zLnZ6YSkgLSBNYXRoLlBJIC8gNDsKCiAgICByZXR1cm4ga3ZvbDsKfQoKZnVuY3Rpb24gY2FsY19yaG9fbW9kaXMoa2dlbywga3ZvbCwgZikgewogICAgLy8gRXEuIDYgaW4gUm95IGV0IGFsIDIwMTcsIEVxLiAzNyBpbiBMdWNodCBldCBhbCAyMDAwCiAgICByZXR1cm4gZlswXSArIGZbMV0gKiBrZ2VvICsgZlsyXSAqIGt2b2w7Cn0KCmZ1bmN0aW9uIGNhbGNfY19sYW1iZGEoa2VybmVscywgZikgewogICAgLy8gUGFydCAyIG9mIEVxLiA1IGluIFJveSBldCBhbCAyMDE3CiAgICByZXR1cm4gY2FsY19yaG9fbW9kaXMoa2VybmVscy5rZ2VvX3Z6YV96ZXJvLCBrZXJuZWxzLmt2b2xfdnphX3plcm8sIGYpIC8gY2FsY19yaG9fbW9kaXMoa2VybmVscy5rZ2VvLCBrZXJuZWxzLmt2b2wsIGYpOwp9CgpmdW5jdGlvbiBjYWxjX25iYXIocl9zMiwgZiwga2VybmVscykgewogICAgLy9QYXJ0IDEgb2YgRXEuIDUgaW4gUm95IGV0IGFsIDIwMTcKICAgIC8vIHJfczI6IHJlZmxlY3RhbmNlIGluIGJhbmQgCiAgICAvLyBmOiBmIHZhbHVlcyBmb3IgYmFuZAogICAgbGV0IGNfbGFtYmRhID0gY2FsY19jX2xhbWJkYShrZXJuZWxzLCBmKTsKICAgIHJldHVybiBjX2xhbWJkYSAqIHJfczI7Cn0K&datasetId=S2L2A&fromTime=2022-01-01T00%3A00%3A00.000Z&toTime=2022-01-04T23%3A59%3A59.999Z&minQa=NaN&demSource3D=%22MAPZEN%22#custom-script){:target="_blank"}

## General description of the script

Implementing of a Bidirectional Reflectance Distribution Function (BRDF) normalisation for Sentinel-2 scenes in a Sentinel Hub [Evalscript](https://docs.sentinel-hub.com/api/latest/evalscript/v3/).

The Evascript proposed here is the "semi-empirical BRDF normalisation c-factor correction approach proposed by Luch et al. 2000 [1]. The formula is detailed in eq. 37 (using eq. 38 & 39). To avoid lookup tables and other complex modelling approaches, we use the fixed BRDF spectral model parameters derived from "the global year of highest quality snow-free MODIS BRDF product" conveniently defined for Sentinel-2 in Roy et al. 2017 [2] that were derived from the Landsat ones in Roy et al. 2016 [3].

The approach seems to perform generally quite well for most surfaces (except snow and ice) and high sun angles. Nevertherless, it relies on a certain number of approximations and may not always be suitable.


## Description of representative images

**Top image**: True Colour RGB acquired with Sentinel-2 (L2A processing level) over the Australian desert, on the border between Queensland and South Australia. The image is composed of two acquisitions from different orbits from 2nd January 2022 and 4th January 2022.

**Bottom image**: Identical to the top image, with the BRDF normalisation applied.

![Uncorrected](fig/uncorrected.jpg)
![Corrected](fig/corrected.jpg)


## References

[1] W. Lucht, C. B. Schaaf and A. H. Strahler, "An algorithm for the retrieval of albedo from space using semiempirical BRDF models," in IEEE Transactions on Geoscience and Remote Sensing, vol. 38, no. 2, pp. 977-998, March 2000, doi: https://doi.org/10.1109/36.841980.

[2] David P. Roy, Jian Li, Hankui K. Zhang, Lin Yan, Haiyan Huang, Zhongbin Li, Examination of Sentinel-2A multi-spectral instrument (MSI) reflectance anisotropy and the suitability of a general method to normalize MSI reflectance to nadir BRDF adjusted reflectance, Remote Sensing of Environment, Volume 199, 2017, Pages 25-38, ISSN 0034-4257, https://doi.org/10.1016/j.rse.2017.06.019.

[3] D.P. Roy, H.K. Zhang, J. Ju, J.L. Gomez-Dans, P.E. Lewis, C.B. Schaaf, Q. Sun, J. Li, H. Huang, V. Kovalskyy, A general method to normalize Landsat reflectance data to nadir BRDF adjusted reflectance, Remote Sensing of Environment, Volume 176, 2016, Pages 255-271, ISSN 0034-4257, https://doi.org/10.1016/j.rse.2016.01.023.